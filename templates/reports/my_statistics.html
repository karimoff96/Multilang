{% extends 'layout/layout.html' %} 

{% block content %}
<div class="row gy-4">
    <!-- Header -->
    <div class="col-12">
        <div class="card radius-8 border-0">
            <div class="card-body p-24">
                <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
                    <div>
                        <h5 class="fw-bold mb-0">
                            <iconify-icon icon="solar:chart-bold" class="text-primary-600 me-2"></iconify-icon>
                            <span data-i18n="report.myStatistics">{{ title }}</span>
                        </h5>
                        <p class="text-secondary-light mb-0" data-i18n="report.myStatisticsDesc">{{ subTitle }}</p>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="badge bg-success-100 text-success-600 px-3 py-2 rounded-pill">
                            <iconify-icon icon="solar:check-circle-bold" class="me-1"></iconify-icon>
                            <span data-i18n="report.completionRate">Completion Rate:</span>
                            <span class="fw-bold">{{ completion_rate }}%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Stats -->
    <div class="col-xxl-3 col-sm-6">
        <div class="card radius-8 border-0 overflow-hidden">
            <div class="card-body p-24 position-relative">
                <div class="position-absolute top-0 end-0 w-50-px h-50-px bg-primary-100 rounded-circle" style="margin: -15px -15px 0 0;"></div>
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="w-48-px h-48-px bg-primary-100 d-flex justify-content-center align-items-center rounded-circle">
                        <iconify-icon icon="solar:calendar-bold" class="text-primary-600 text-xl"></iconify-icon>
                    </div>
                    <span class="text-secondary-light text-sm" data-i18n="report.today">Today</span>
                </div>
                <h4 class="mb-1 fw-bold">{{ today_count }}</h4>
                <span class="text-sm text-secondary-light" data-i18n="report.ordersAssigned">Orders Assigned</span>
                <div class="mt-3 d-flex gap-3">
                    <div class="d-flex align-items-center gap-1">
                        <iconify-icon icon="solar:check-circle-bold" class="text-success-main"></iconify-icon>
                        <span class="text-sm">{{ today_completed }} <span data-i18n="report.completed">Completed</span></span>
                    </div>
                </div>
                <div class="mt-2">
                    <iconify-icon icon="solar:document-text-bold" class="text-info-main"></iconify-icon>
                    <span class="text-sm">{{ today_pages }} <span data-i18n="report.pages">Pages</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- This Week Stats -->
    <div class="col-xxl-3 col-sm-6">
        <div class="card radius-8 border-0 overflow-hidden">
            <div class="card-body p-24 position-relative">
                <div class="position-absolute top-0 end-0 w-50-px h-50-px bg-warning-100 rounded-circle" style="margin: -15px -15px 0 0;"></div>
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="w-48-px h-48-px bg-warning-100 d-flex justify-content-center align-items-center rounded-circle">
                        <iconify-icon icon="solar:calendar-mark-bold" class="text-warning-600 text-xl"></iconify-icon>
                    </div>
                    <span class="text-secondary-light text-sm" data-i18n="report.thisWeek">This Week</span>
                </div>
                <h4 class="mb-1 fw-bold">{{ week_count }}</h4>
                <span class="text-sm text-secondary-light" data-i18n="report.ordersAssigned">Orders Assigned</span>
                <div class="mt-3 d-flex gap-3">
                    <div class="d-flex align-items-center gap-1">
                        <iconify-icon icon="solar:check-circle-bold" class="text-success-main"></iconify-icon>
                        <span class="text-sm">{{ week_completed }} <span data-i18n="report.completed">Completed</span></span>
                    </div>
                </div>
                <div class="mt-2">
                    <iconify-icon icon="solar:document-text-bold" class="text-info-main"></iconify-icon>
                    <span class="text-sm">{{ week_pages }} <span data-i18n="report.pages">Pages</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- This Month Stats -->
    <div class="col-xxl-3 col-sm-6">
        <div class="card radius-8 border-0 overflow-hidden">
            <div class="card-body p-24 position-relative">
                <div class="position-absolute top-0 end-0 w-50-px h-50-px bg-info-100 rounded-circle" style="margin: -15px -15px 0 0;"></div>
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="w-48-px h-48-px bg-info-100 d-flex justify-content-center align-items-center rounded-circle">
                        <iconify-icon icon="solar:calendar-minimalistic-bold" class="text-info-600 text-xl"></iconify-icon>
                    </div>
                    <span class="text-secondary-light text-sm" data-i18n="report.thisMonth">This Month</span>
                </div>
                <h4 class="mb-1 fw-bold">{{ month_count }}</h4>
                <span class="text-sm text-secondary-light" data-i18n="report.ordersAssigned">Orders Assigned</span>
                <div class="mt-3 d-flex gap-3">
                    <div class="d-flex align-items-center gap-1">
                        <iconify-icon icon="solar:check-circle-bold" class="text-success-main"></iconify-icon>
                        <span class="text-sm">{{ month_completed }} <span data-i18n="report.completed">Completed</span></span>
                    </div>
                </div>
                <div class="mt-2">
                    <iconify-icon icon="solar:document-text-bold" class="text-info-main"></iconify-icon>
                    <span class="text-sm">{{ month_pages }} <span data-i18n="report.pages">Pages</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- All Time Stats -->
    <div class="col-xxl-3 col-sm-6">
        <div class="card radius-8 border-0 overflow-hidden">
            <div class="card-body p-24 position-relative">
                <div class="position-absolute top-0 end-0 w-50-px h-50-px bg-success-100 rounded-circle" style="margin: -15px -15px 0 0;"></div>
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="w-48-px h-48-px bg-success-100 d-flex justify-content-center align-items-center rounded-circle">
                        <iconify-icon icon="solar:history-bold" class="text-success-600 text-xl"></iconify-icon>
                    </div>
                    <span class="text-secondary-light text-sm" data-i18n="report.allTime">All Time</span>
                </div>
                <h4 class="mb-1 fw-bold">{{ total_count }}</h4>
                <span class="text-sm text-secondary-light" data-i18n="report.totalOrders">Total Orders</span>
                <div class="mt-3 d-flex gap-3">
                    <div class="d-flex align-items-center gap-1">
                        <iconify-icon icon="solar:check-circle-bold" class="text-success-main"></iconify-icon>
                        <span class="text-sm">{{ total_completed }} <span data-i18n="report.completed">Completed</span></span>
                    </div>
                </div>
                <div class="mt-2">
                    <iconify-icon icon="solar:document-text-bold" class="text-info-main"></iconify-icon>
                    <span class="text-sm">{{ total_pages }} <span data-i18n="report.pages">Pages</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Performance Chart -->
    <div class="col-xxl-8">
        <div class="card radius-8 border-0 h-100">
            <div class="card-body p-24">
                <h6 class="fw-bold text-lg mb-4" data-i18n="report.dailyPerformance">Daily Performance (This Month)</h6>
                <div id="dailyPerformanceChart" style="min-height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Status Breakdown -->
    <div class="col-xxl-4">
        <div class="card radius-8 border-0 h-100">
            <div class="card-body p-24">
                <h6 class="fw-bold text-lg mb-4" data-i18n="report.ordersByStatus">Orders by Status (This Month)</h6>
                <div id="statusChart" style="min-height: 300px;"></div>
            </div>
        </div>
    </div>

    <!-- Recent Orders Table -->
    <div class="col-12">
        <div class="card radius-8 border-0">
            <div class="card-body p-24">
                <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
                    <h6 class="fw-bold text-lg mb-0" data-i18n="report.recentOrders">Recent Orders</h6>
                    <a href="{% url 'order_list' %}" class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1">
                        <span data-i18n="common.viewAll">View All</span>
                        <iconify-icon icon="solar:arrow-right-line-duotone"></iconify-icon>
                    </a>
                </div>
                <div class="table-responsive">
                    <table class="table bordered-table mb-0">
                        <thead>
                            <tr>
                                <th scope="col" data-i18n="order.id">Order ID</th>
                                <th scope="col" data-i18n="order.customer">Customer</th>
                                <th scope="col" data-i18n="order.product">Product</th>
                                <th scope="col" data-i18n="order.pages">Pages</th>
                                <th scope="col" data-i18n="order.status">Status</th>
                                <th scope="col" data-i18n="order.createdAt">Created</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td><a href="{% url 'order_detail' order.id %}" class="text-primary-600">#{{ order.id }}</a></td>
                                <td>{{ order.bot_user.full_name|default:order.bot_user.phone_number }}</td>
                                <td>{{ order.product.name|default:"-" }}</td>
                                <td>{{ order.total_pages|default:0 }}</td>
                                <td>
                                    {% if order.status == 'completed' %}
                                    <span class="badge bg-success-100 text-success-600 px-2 py-1 radius-4">Completed</span>
                                    {% elif order.status == 'in_progress' %}
                                    <span class="badge bg-primary-100 text-primary-600 px-2 py-1 radius-4">In Progress</span>
                                    {% elif order.status == 'pending' %}
                                    <span class="badge bg-warning-100 text-warning-600 px-2 py-1 radius-4">Pending</span>
                                    {% elif order.status == 'cancelled' %}
                                    <span class="badge bg-danger-100 text-danger-600 px-2 py-1 radius-4">Cancelled</span>
                                    {% else %}
                                    <span class="badge bg-secondary-100 text-secondary-600 px-2 py-1 radius-4">{{ order.status }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ order.created_at|date:"d M Y H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-secondary-light py-4">
                                    <iconify-icon icon="solar:inbox-line-duotone" class="text-4xl mb-2"></iconify-icon>
                                    <p class="mb-0" data-i18n="report.noOrdersFound">No orders found</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Daily Performance Chart
    const dailyLabels = {{ daily_labels|safe }};
    const dailyCounts = {{ daily_counts|safe }};
    const dailyPages = {{ daily_pages|safe }};

    if (dailyLabels.length > 0) {
        const dailyOptions = {
            series: [{
                name: 'Orders',
                type: 'column',
                data: dailyCounts
            }, {
                name: 'Pages',
                type: 'line',
                data: dailyPages
            }],
            chart: {
                height: 300,
                type: 'line',
                toolbar: { show: false }
            },
            stroke: {
                width: [0, 3],
                curve: 'smooth'
            },
            plotOptions: {
                bar: {
                    borderRadius: 4,
                    columnWidth: '60%'
                }
            },
            fill: {
                opacity: [0.85, 1]
            },
            labels: dailyLabels,
            markers: {
                size: 4
            },
            yaxis: [{
                title: { text: 'Orders' }
            }, {
                opposite: true,
                title: { text: 'Pages' }
            }],
            colors: ['#487FFF', '#45B369']
        };
        new ApexCharts(document.querySelector("#dailyPerformanceChart"), dailyOptions).render();
    } else {
        document.querySelector("#dailyPerformanceChart").innerHTML = '<div class="text-center text-secondary-light py-5"><iconify-icon icon="solar:chart-2-line-duotone" class="text-4xl mb-2"></iconify-icon><p>No data for this month</p></div>';
    }

    // Status Chart
    const statusData = {{ status_data|safe }};
    
    if (statusData.length > 0) {
        const statusLabels = statusData.map(item => item.label);
        const statusValues = statusData.map(item => item.count);
        const statusColors = statusData.map(item => item.color);

        const statusOptions = {
            series: statusValues,
            chart: {
                type: 'donut',
                height: 300
            },
            labels: statusLabels,
            colors: statusColors,
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: 'Total',
                                formatter: function(w) {
                                    return w.globals.seriesTotals.reduce((a, b) => a + b, 0);
                                }
                            }
                        }
                    }
                }
            },
            legend: {
                position: 'bottom'
            }
        };
        new ApexCharts(document.querySelector("#statusChart"), statusOptions).render();
    } else {
        document.querySelector("#statusChart").innerHTML = '<div class="text-center text-secondary-light py-5"><iconify-icon icon="solar:pie-chart-2-line-duotone" class="text-4xl mb-2"></iconify-icon><p>No data for this month</p></div>';
    }
});
</script>
{% endblock %}
