{% extends 'layout/layout.html' %}

{% block content %}
<div class="row gy-4">
    <div class="col-12">
        <div class="card radius-8 border-0">
            <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-3 py-16 px-24 border-bottom bg-base">
                <div>
                    <h6 class="mb-0 fw-bold text-lg" {% if title_i18n %}data-i18n="{{ title_i18n }}"{% endif %}>{{ title }}</h6>
                    <span class="text-sm text-secondary-light" {% if subTitle_i18n %}data-i18n="{{ subTitle_i18n }}"{% endif %} data-i18n="common.manageRoles">Manage roles and permissions for your platform</span>
                </div>
                <a href="{% url 'role_create' %}" class="btn btn-primary text-sm btn-sm px-12 py-6 radius-4 d-flex align-items-center gap-2">
                    <iconify-icon icon="ic:baseline-plus" class="icon text-xl line-height-1"></iconify-icon>
                    <span data-i18n="common.createNewRole">Create New Role</span>
                </a>
            </div>
            <div class="card-body p-24 compact-table">
                <div class="table-responsive scroll-sm">
                    <table class="table colored-row-table mb-0">
                        <thead>
                            <tr>
                                <th scope="col" class="bg-base text-secondary-light" data-i18n="table.roleName">Role Name</th>
                                <th scope="col" class="bg-base text-secondary-light" data-i18n="table.description">Description</th>
                                <th scope="col" class="bg-base text-secondary-light text-center" data-i18n="table.users">Users</th>
                                <th scope="col" class="bg-base text-secondary-light" data-i18n="table.permissions">Key Permissions</th>
                                <th scope="col" class="bg-base text-secondary-light text-center" data-i18n="table.actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for role in roles %}
                            {% cycle 'bg-primary-light' 'bg-success-focus' 'bg-info-focus' 'bg-warning-focus' 'bg-danger-focus' as row_color silent %}
                            <tr>
                                <td class="{{ row_color }}">
                                    <div class="d-flex align-items-center gap-2">
                                        {% if role.is_system_role %}
                                        <span class="badge bg-primary-100 text-primary-600 px-8 py-4 radius-4 text-xs" data-i18n="common.system">System</span>
                                        {% endif %}
                                        {% if not role.is_active %}
                                        <span class="badge bg-danger-100 text-danger-600 px-8 py-4 radius-4 text-xs" data-i18n="common.inactive">Inactive</span>
                                        {% endif %}
                                        <span class="fw-semibold text-secondary-light">{{ role.display_name }}</span>
                                    </div>
                                </td>
                                <td class="{{ row_color }} hide-mobile">
                                    <span class="text-secondary-light">{{ role.description|default:"-"|truncatechars:50 }}</span>
                                </td>
                                <td class="{{ row_color }} text-center">
                                    <span class="badge bg-info-100 text-info-600 px-8 py-4 radius-4">{{ role.user_count }}</span>
                                </td>
                                <td class="{{ row_color }} hide-tablet">
                                    <div class="d-flex flex-wrap gap-1">
                                        <!-- Organization -->
                                        {% if role.can_manage_centers %}
                                        <span class="badge bg-primary-100 text-primary-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.fullCenterManagement" title="Full Center Management">üè¢ Centers</span>
                                        {% endif %}
                                        {% if role.can_manage_branches %}
                                        <span class="badge bg-primary-100 text-primary-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.manageBranches" title="Manage Branches">üè™ Branches</span>
                                        {% endif %}
                                        {% if role.can_manage_staff %}
                                        <span class="badge bg-info-100 text-info-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.manageStaff" title="Manage Staff">üë• Staff</span>
                                        {% endif %}
                                        
                                        <!-- Orders (prioritize master permission) -->
                                        {% if role.can_manage_orders %}
                                        <span class="badge bg-success-100 text-success-600 px-6 py-2 radius-4 text-xs" title="Full Order Management">üì¶ Full Orders</span>
                                        {% else %}
                                            {% if role.can_edit_orders %}
                                            <span class="badge bg-success-100 text-success-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.editOrders" title="Edit Orders">‚úèÔ∏è Edit</span>
                                            {% endif %}
                                            {% if role.can_delete_orders %}
                                            <span class="badge bg-danger-100 text-danger-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.deleteOrders" title="Delete Orders">üóëÔ∏è Delete</span>
                                            {% endif %}
                                            {% if role.can_assign_orders %}
                                            <span class="badge bg-success-100 text-success-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.assignOrders" title="Assign Orders">üìã Assign</span>
                                            {% endif %}
                                            {% if role.can_update_order_status %}
                                            <span class="badge bg-success-100 text-success-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.updateStatus" title="Update Status">üîÑ Status</span>
                                            {% endif %}
                                            {% if role.can_complete_orders %}
                                            <span class="badge bg-success-100 text-success-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.completeOrders" title="Complete Orders">‚úÖ Complete</span>
                                            {% endif %}
                                        {% endif %}
                                        
                                        <!-- Financial -->
                                        {% if role.can_receive_payments %}
                                        <span class="badge bg-warning-100 text-warning-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.receivePayments" title="Receive Payments">üí∞ Payments</span>
                                        {% endif %}
                                        {% if role.can_apply_discounts %}
                                        <span class="badge bg-warning-100 text-warning-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.applyDiscounts" title="Apply Discounts">üè∑Ô∏è Discounts</span>
                                        {% endif %}
                                        {% if role.can_refund_orders %}
                                        <span class="badge bg-danger-100 text-danger-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.refundOrders" title="Refund Orders">‚Ü©Ô∏è Refunds</span>
                                        {% endif %}
                                        
                                        <!-- Reports -->
                                        {% if role.can_view_reports or role.can_view_analytics %}
                                        <span class="badge bg-purple-100 text-purple-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.viewReportsAnalytics" title="View Reports/Analytics">üìä Reports</span>
                                        {% endif %}
                                        {% if role.can_export_data %}
                                        <span class="badge bg-purple-100 text-purple-600 px-6 py-2 radius-4 text-xs" data-i18n-title="permissions.exportData" title="Export Data">üì• Export</span>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="{{ row_color }} text-center col-action">
                                    <div class="d-flex align-items-center justify-content-center gap-2">
                                        <a href="{% url 'role_edit' role.id %}" class="btn btn-sm btn-icon btn-outline-primary radius-4" data-i18n-title="common.edit" title="Edit">
                                            <iconify-icon icon="lucide:edit" class="icon"></iconify-icon>
                                        </a>
                                        {% if role.is_system_role %}
                                        <button type="button" class="btn btn-sm btn-icon btn-outline-secondary radius-4" disabled data-i18n-title="role.systemDeleteBlocked" title="System roles cannot be deleted">
                                            <iconify-icon icon="lucide:trash-2" class="icon"></iconify-icon>
                                        </button>
                                        {% elif role.user_count > 0 %}
                                        <button type="button" class="btn btn-sm btn-icon btn-outline-secondary radius-4" disabled data-i18n-title="role.assignedDeleteBlocked" title="Cannot delete - {{ role.user_count }} user(s) assigned. Reassign users first.">
                                            <iconify-icon icon="lucide:trash-2" class="icon"></iconify-icon>
                                        </button>
                                        {% else %}
                                        <form method="POST" action="{% url 'role_delete' role.id %}" class="d-inline" onsubmit="return confirm(window.LanguageManager ? window.LanguageManager.translate('role.deleteConfirm') : 'Are you sure you want to delete this role?');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-sm btn-icon btn-outline-danger radius-4" data-i18n-title="common.delete" title="Delete">
                                                <iconify-icon icon="lucide:trash-2" class="icon"></iconify-icon>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-secondary-light py-4 bg-base" data-i18n="common.noRolesFound">
                                    No roles found. Create your first role!
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Permission Categories Legend -->
    <div class="col-12">
        <div class="card radius-8 border-0">
            <div class="card-header py-16 px-24 border-bottom bg-base">
                <h6 class="mb-0 fw-semibold d-flex align-items-center gap-2">
                    <iconify-icon icon="lucide:info"></iconify-icon>
                    <span data-i18n="common.permissionReference">Permission Categories</span>
                </h6>
            </div>
            <div class="card-body p-24">
                <div class="row g-4">
                    <div class="col-md-4 col-sm-6">
                        <h6 class="text-sm fw-semibold text-primary-main mb-2" data-i18n="role.legend.organization">üè¢ Organization</h6>
                        <ul class="list-unstyled text-sm text-secondary-light mb-0">
                            <li data-i18n="role.legend.manageCenters">‚Ä¢ Manage Centers</li>
                            <li data-i18n="role.legend.manageBranches">‚Ä¢ Manage Branches</li>
                        </ul>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <h6 class="text-sm fw-semibold text-info-main mb-2" data-i18n="role.legend.staff">üë• Staff</h6>
                        <ul class="list-unstyled text-sm text-secondary-light mb-0">
                            <li data-i18n="role.legend.manageStaff">‚Ä¢ Manage Staff</li>
                            <li data-i18n="role.legend.viewStaff">‚Ä¢ View Staff (Read-Only)</li>
                        </ul>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <h6 class="text-sm fw-semibold text-success-main mb-2" data-i18n="role.legend.orders">üì¶ Orders</h6>
                        <ul class="list-unstyled text-sm text-secondary-light mb-0">
                            <li data-i18n="role.legend.fullOrders">‚Ä¢ Full Order Management (master)</li>
                            <li data-i18n="role.legend.crudOrders">‚Ä¢ View/Create/Edit/Delete</li>
                            <li data-i18n="role.legend.assignOrders">‚Ä¢ Assign/Status/Complete/Cancel</li>
                        </ul>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <h6 class="text-sm fw-semibold text-warning-main mb-2" data-i18n="role.legend.financial">üí∞ Financial</h6>
                        <ul class="list-unstyled text-sm text-secondary-light mb-0">
                            <li data-i18n="role.legend.receivePayments">‚Ä¢ Receive Payments</li>
                            <li data-i18n="role.legend.applyDiscounts">‚Ä¢ Apply Discounts</li>
                            <li data-i18n="role.legend.refundOrders">‚Ä¢ Refund Orders</li>
                        </ul>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <h6 class="text-sm fw-semibold text-purple-main mb-2" data-i18n="role.legend.reports">üìä Reports</h6>
                        <ul class="list-unstyled text-sm text-secondary-light mb-0">
                            <li data-i18n="role.legend.viewReports">‚Ä¢ View Reports & Analytics</li>
                            <li data-i18n="role.legend.exportData">‚Ä¢ Export Data (Excel/CSV)</li>
                        </ul>
                    </div>
                    <div class="col-md-4 col-sm-6">
                        <h6 class="text-sm fw-semibold text-danger-main mb-2" data-i18n="role.legend.products">üì¶ Products & Customers</h6>
                        <ul class="list-unstyled text-sm text-secondary-light mb-0">
                            <li data-i18n="role.legend.manageProducts">‚Ä¢ Manage Products</li>
                            <li data-i18n="role.legend.manageCustomers">‚Ä¢ Manage Customers</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}
