{% extends '../layout/layout.html' %}
{% load static %}

{% block content %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    /* Select2 styling to exactly match native .form-select elements */
    .select2-container {
        width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
        display: block !important;
        box-sizing: border-box !important;
    }
    
    /* Ensure all nested wrappers are full width */
    .select2-container .selection,
    .select2-container .select2-selection {
        width: 100% !important;
        display: block !important;
        box-sizing: border-box !important;
    }
    
    /* Main select box - match .form-select exactly */
    .select2-container .select2-selection--single {
        height: 46px !important;
        padding: 0 !important;
        margin: 0 !important;
        font-size: 14px !important;
        line-height: 1.5 !important;
        color: inherit !important;
        background-color: var(--base, #ffffff) !important;
        background-clip: padding-box !important;
        border: 1px solid var(--neutral-300, #D1D5DB) !important;
        border-radius: 8px !important;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out !important;
        box-shadow: none !important;
        display: block !important;
    }
    
    /* Selected text styling */
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        display: block !important;
        padding-left: 16px !important;
        padding-right: 40px !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        line-height: 44px !important;
        font-size: 14px !important;
        color: var(--text-primary-light, #111827) !important;
        margin: 0 !important;
    }
    
    /* Placeholder text */
    .select2-container--default .select2-selection--single .select2-selection__placeholder {
        color: var(--neutral-500, #6B7280) !important;
        opacity: 0.7 !important;
    }
    
    /* Dropdown arrow */
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 46px !important;
        position: absolute !important;
        top: 0 !important;
        right: 10px !important;
        width: 20px !important;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow b {
        border-color: var(--neutral-500, #6B7280) transparent transparent transparent !important;
        border-style: solid !important;
        border-width: 5px 4px 0 4px !important;
        height: 0 !important;
        left: 50% !important;
        margin-left: -4px !important;
        margin-top: -2px !important;
        position: absolute !important;
        top: 50% !important;
        width: 0 !important;
    }
    
    /* Focus and open states */
    .select2-container--default.select2-container--focus .select2-selection--single,
    .select2-container--default.select2-container--open .select2-selection--single {
        border-color: #487fff !important;
        outline: 0 !important;
        box-shadow: 0 0 0 0.2rem rgba(72, 127, 255, 0.15) !important;
    }
    
    /* Disabled state */
    .select2-container--default.select2-container--disabled .select2-selection--single {
        background-color: var(--bg-neutral-100, #f5f5f5) !important;
        cursor: not-allowed !important;
        opacity: 0.6 !important;
    }
    
    /* Dropdown container */
    .select2-dropdown {
        background-color: var(--base, #ffffff) !important;
        border: 1px solid var(--neutral-300, #d5d5d5) !important;
        border-radius: 8px !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
        margin-top: 4px !important;
        z-index: 9999 !important;
    }
    
    /* Dropdown results container */
    .select2-results {
        background-color: var(--base, #ffffff) !important;
    }
    
    /* Dropdown options */
    .select2-container--default .select2-results__option {
        padding: 10px 16px !important;
        font-size: 14px !important;
        color: var(--text-primary-light, #111827) !important;
        background-color: var(--base, #ffffff) !important;
        cursor: pointer !important;
        transition: background-color 0.15s ease !important;
    }
    
    /* Highlighted option */
    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: var(--primary-600, #487fff) !important;
        color: #ffffff !important;
    }
    
    /* Selected option */
    .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: var(--neutral-100, #F3F4F6) !important;
        color: var(--text-primary-light, #111827) !important;
    }
    
    /* Search box in dropdown */
    .select2-search--dropdown {
        padding: 8px !important;
        background-color: var(--base, #ffffff) !important;
    }
    
    .select2-search--dropdown .select2-search__field {
        padding: 8px 12px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        border: 1px solid var(--neutral-300, #d5d5d5) !important;
        border-radius: 6px !important;
        background-color: var(--neutral-50, #F5F6FA) !important;
        color: var(--text-primary-light, #111827) !important;
        font-size: 14px !important;
    }
    
    /* === Dark Mode Overrides === */
    html[data-theme=dark] .select2-dropdown {
        background-color: #273142 !important;
        border-color: #4B5563 !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3) !important;
    }
    
    html[data-theme=dark] .select2-results {
        background-color: #273142 !important;
    }
    
    html[data-theme=dark] .select2-container--default .select2-results__option {
        color: #FFFFFF !important;
        background-color: #273142 !important;
    }
    
    html[data-theme=dark] .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #487fff !important;
        color: #FFFFFF !important;
    }
    
    html[data-theme=dark] .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: #323D4E !important;
        color: #FFFFFF !important;
    }
    
    html[data-theme=dark] .select2-search--dropdown {
        background-color: #273142 !important;
    }
    
    html[data-theme=dark] .select2-search--dropdown .select2-search__field {
        background-color: #323D4E !important;
        border-color: #4B5563 !important;
        color: #FFFFFF !important;
    }
    
    html[data-theme=dark] .select2-search--dropdown .select2-search__field:focus {
        border-color: #487fff !important;
    }
    
    /* No results message */
    .select2-container--default .select2-results__message {
        color: var(--text-secondary-light, #6c757d) !important;
        padding: 10px 16px !important;
    }
    
    html[data-theme=dark] .select2-container--default .select2-results__message {
        color: #9CA3AF !important;
    }
    
    /* === Additional Dark Mode for Main Selection Box === */
    html[data-theme=dark] .select2-container .select2-selection--single {
        background-color: #323D4E !important;
        border-color: #4B5563 !important;
    }
    
    html[data-theme=dark] .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #F3F4F6 !important;
    }
    
    html[data-theme=dark] .select2-container--default .select2-selection--single .select2-selection__placeholder {
        color: #6B7280 !important;
    }
    
    html[data-theme=dark] .select2-container--default .select2-selection--single .select2-selection__arrow b {
        border-color: #9CA3AF transparent transparent transparent !important;
    }
    
    html[data-theme=dark] .select2-container--default.select2-container--disabled .select2-selection--single {
        background-color: var(--dark-1, #1B2431) !important;
        opacity: 0.5 !important;
    }
</style>

<div class="row gy-4">
    <div class="col-lg-8">
        <div class="card h-100 p-0 radius-12">
            <div class="card-header border-bottom bg-base py-16 px-24 d-flex align-items-center justify-content-between">
                <h6 class="text-lg fw-semibold mb-0">
                    <iconify-icon icon="solar:add-circle-bold" class="me-2"></iconify-icon>
                    <span data-i18n="orders.createOrder">Create Order</span>
                </h6>
                <a href="{% url 'orders:ordersList' %}" class="btn btn-outline-secondary btn-sm">
                    <iconify-icon icon="ep:back" class="me-1"></iconify-icon> <span data-i18n="detail.back">Back</span>
                </a>
            </div>
            <div class="card-body p-24">
                <form method="post" action="{% url 'orders:orderCreate' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Manual Order Toggle -->
                    <div class="mb-20 p-16 bg-warning-50 radius-8 border border-warning-200">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="manualOrderToggle">
                            <label class="form-check-label fw-semibold" for="manualOrderToggle">
                                <iconify-icon icon="solar:phone-calling-bold" class="me-2 text-warning-600"></iconify-icon>
                                <span data-i18n="orders.manualOrderToggle">Create Manual Order (Phone/Walk-in)</span>
                            </label>
                        </div>
                        <small class="text-secondary-light d-block mt-8" data-i18n="orders.manualOrderHint">
                            Enable this to create an order for customers who contacted via phone or walk-in (without Telegram registration)
                        </small>
                    </div>
                    
                    <!-- Customer Selection (Bot User) -->
                    <div class="row">
                    <div class="col-md-6 mb-20" id="botUserSection">
                        <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="orders.customer">Customer *</label>
                        <select name="bot_user" class="form-select radius-8" id="customerSelect">
                            <option value="" data-i18n="orders.selectCustomerPlaceholder">-- Select Customer --</option>
                            {% for user in bot_users %}
                            <option value="{{ user.id }}">{{ user.display_name }} {% if user.phone_number %}({{ user.phone_number }}){% endif %}</option>
                            {% endfor %}
                        </select>
                        <small class="text-primary-light" data-i18n="orders.selectCustomerHint">Select from existing customers (registered via Telegram bot)</small>
                    </div>
                    </div>
                    
                    <!-- Manual Customer Info (Hidden by default) -->
                    <div id="manualCustomerSection" style="display: none;">
                        <div class="mb-16 p-12 bg-info-50 radius-8 border border-info-200">
                            <iconify-icon icon="solar:info-circle-bold" class="text-info-600 me-2"></iconify-icon>
                            <span class="text-sm text-info-600 fw-medium" data-i18n="orders.manualInfoBanner">Enter customer details manually</span>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-20">
                                <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.customerFirstName">First Name *</label>
                                <input type="text" name="manual_first_name" id="manualFirstName" class="form-control radius-8" data-i18n-placeholder="form.customerFirstName" placeholder="Customer's first name">
                            </div>
                            <div class="col-md-6 mb-20">
                                <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.customerLastName">Last Name</label>
                                <input type="text" name="manual_last_name" id="manualLastName" class="form-control radius-8" data-i18n-placeholder="form.customerLastName" placeholder="Customer's last name">
                            </div>
                        <div class="mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.phoneNumber">Phone Number *</label>
                            <input type="tel" name="manual_phone" id="manualPhone" class="form-control radius-8" data-i18n-placeholder="form.phoneNumber" placeholder="+998 XX XXX XX XX">
                            <small class="text-primary-light" data-i18n="orders.manualPhoneHint">Customer's contact number</small>
                        </div>
                        </div>
                    </div>
                    
                    {% if is_superuser and centers %}
                    <!-- Center and Branch Selection (Superuser only) -->
                    <div class="row">
                        <div class="col-md-6 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.center">Center *</label>
                            <select name="center" class="form-select radius-8" required id="centerSelect">
                                <option value="" data-i18n="orders.centerPlaceholder">-- Select Center --</option>
                                {% for center in centers %}
                                <option value="{{ center.id }}">{{ center.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.branch">Branch *</label>
                            <select name="branch" class="form-select radius-8" required id="branchSelect">
                                <option value="" data-i18n="orders.branchPlaceholderCenterFirst">-- Select Center First --</option>
                            </select>
                        </div>
                    </div>
                    {% else %}
                    <!-- Branch (non-superuser) -->
                    <div class="mb-20">
                        <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.branch">Branch *</label>
                        <select name="branch" class="form-select radius-8" required id="branchSelect">
                            <option value="" data-i18n="orders.branchPlaceholder">-- Select Branch --</option>
                            {% for branch in branches %}
                            <option value="{{ branch.id }}">{{ branch.name }}{% if branch.center %} ({{ branch.center.name }}){% endif %}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    
                    <!-- Product and Language -->
                    <div class="row">
                        <div class="col-md-4 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.category">Category</label>
                            <select name="category" class="form-select radius-8" id="categorySelect">
                                <option value="" data-i18n="orders.categoryPlaceholder">-- All Categories --</option>
                            </select>
                            <small class="text-primary-light" data-i18n="form.categoryHint">Filter products by category</small>
                        </div>
                        <div class="col-md-8 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="detail.productService">Product / Service *</label>
                            <select name="product" class="form-select radius-8" required id="productSelect">
                                <option value="" data-i18n="orders.productPlaceholder">-- Select Product --</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Language -->
                    <div class="row">
                        <div class="col-md-12 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.language">Language</label>
                            <select name="language" class="form-select radius-8">
                                <option value="" data-i18n="orders.languageOptional">-- Optional --</option>
                                {% for language in languages %}
                                <option value="{{ language.id }}">{{ language.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Total Pages and Copies -->
                    <div class="row">
                        <div class="col-md-4 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="detail.totalPages">Total Pages *</label>
                            <input type="number" name="total_pages" id="totalPages" class="form-control radius-8" value="1" min="1" required>
                        </div>
                        <div class="col-md-4 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="detail.copies">Copies</label>
                            <input type="number" name="copy_number" id="copyNumber" class="form-control radius-8" value="0" min="0">
                            <small class="text-primary-light d-block mt-4" data-i18n="orders.copyZeroHint">0 = original only</small>
                        </div>
                        <div class="col-md-4 mb-20">
                            <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="table.payment">Payment Type *</label>
                            <select name="payment_type" id="paymentType" class="form-select radius-8" required>
                                {% for value, label in payment_choices %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Payment Receipt Upload (shown for card payments) -->
                    <div class="mb-20" id="receiptSection" style="display: none;">
                        <label class="form-label fw-semibold text-primary-light text-sm mb-8">
                            <iconify-icon icon="solar:document-add-bold" class="me-1"></iconify-icon>
                            <span data-i18n="orders.paymentReceipt">Payment Receipt</span>
                        </label>
                        <input type="file" name="recipt" class="form-control radius-8" accept="image/*,.pdf">
                        <small class="text-primary-light" data-i18n="orders.paymentReceiptHint">Upload payment receipt for card transactions</small>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-20">
                        <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="form.description">Description</label>
                        <textarea name="description" class="form-control radius-8" rows="3" data-i18n-placeholder="form.optionalNotes" placeholder="Optional notes or special instructions..."></textarea>
                    </div>
                    
                    <!-- File Upload -->
                    <div class="mb-20">
                        <label class="form-label fw-semibold text-primary-light text-sm mb-8" data-i18n="detail.attachedFiles">Files (Optional)</label>
                        <input type="file" name="files" class="form-control radius-8" multiple accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png">
                        <small class="text-primary-light" data-i18n="orders.fileUploadHint">Upload documents to be translated/processed</small>
                    </div>
                    
                    <!-- Estimated Price Display -->
                    <div class="mb-24 p-16 bg-muted radius-8 border">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-semibold text-secondary-light" data-i18n="orders.estimatedTotal">Estimated Total:</span>
                            <span class="fw-bold text-primary-600 text-xl" id="estimatedPrice">0 UZS</span>
                        </div>
                        <small class="text-primary-light" data-i18n="orders.estimatedTotalNote">* Final price may vary based on actual document pages</small>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'orders:ordersList' %}" class="btn btn-outline-secondary px-24">
                            <iconify-icon icon="ep:back" class="me-1"></iconify-icon> <span data-i18n="common.cancel">Cancel</span>
                        </a>
                        <button type="submit" class="btn btn-success px-24">
                            <iconify-icon icon="solar:add-circle-bold" class="me-2"></iconify-icon> <span data-i18n="orders.createOrder">Create Order</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sidebar Info -->
    <div class="col-lg-4">
        <div class="card radius-12">
            <div class="card-header border-bottom bg-base py-16 px-24">
                <h6 class="text-lg fw-semibold mb-0">
                    <iconify-icon icon="solar:info-circle-bold" class="me-2 text-info-600"></iconify-icon>
                    <span data-i18n="orders.guidelinesTitle">Order Guidelines</span>
                </h6>
            </div>
            <div class="card-body p-24">
                <div class="mb-16">
                    <h6 class="text-sm fw-semibold mb-8" data-i18n="orders.requiredFieldsTitle">Required Fields:</h6>
                    <ul class="list-unstyled text-sm text-secondary-light">
                        <li class="mb-4"><iconify-icon icon="mdi:check-circle" class="text-success-600 me-2"></iconify-icon> <span data-i18n="orders.requiredCustomer">Customer (bot user OR manual info)</span></li>
                        <li class="mb-4"><iconify-icon icon="mdi:check-circle" class="text-success-600 me-2"></iconify-icon> <span data-i18n="orders.requiredBranch">Branch</span></li>
                        <li class="mb-4"><iconify-icon icon="mdi:check-circle" class="text-success-600 me-2"></iconify-icon> <span data-i18n="orders.requiredProduct">Product/Service</span></li>
                        <li class="mb-4"><iconify-icon icon="mdi:check-circle" class="text-success-600 me-2"></iconify-icon> <span data-i18n="orders.requiredPages">Total Pages</span></li>
                        <li class="mb-4"><iconify-icon icon="mdi:check-circle" class="text-success-600 me-2"></iconify-icon> <span data-i18n="orders.requiredPayment">Payment Type</span></li>
                    </ul>
                </div>
                
                <div class="mb-16">
                    <h6 class="text-sm fw-semibold mb-8" data-i18n="orders.manualOrdersTitle">Manual Orders:</h6>
                    <p class="text-sm text-secondary-light mb-0" data-i18n="orders.manualOrdersDesc">
                        Enable "Manual Order" to create orders for walk-in customers or phone orders. You'll need to enter their name and phone number manually.
                    </p>
                </div>
                
                <div class="mb-16">
                    <h6 class="text-sm fw-semibold mb-8" data-i18n="orders.noteTitle">Note:</h6>
                    <p class="text-sm text-secondary-light mb-0" data-i18n="orders.pendingNote">
                        Orders created manually will be in "Pending" status. You can assign staff and update status after creation.
                    </p>
                </div>
                
                <div class="alert alert-warning-100 text-warning-600 p-12 radius-8">
                    <iconify-icon icon="solar:info-circle-bold" class="me-2"></iconify-icon>
                    <span class="text-sm" data-i18n="orders.botUserAlert">For bot users: Customers must first register through the Telegram bot before appearing in the dropdown.</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Branch data as JSON for reliable JavaScript access -->
<script id="branchesJson" type="application/json">
{% if is_superuser and centers and branches %}
[{% for branch in branches %}{"id": {{ branch.id }}, "center_id": {{ branch.center_id }}, "name": "{{ branch.name }}"}{% if not forloop.last %},{% endif %}{% endfor %}]
{% else %}
[]
{% endif %}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Select2 for customer search
    $('#customerSelect').select2({
        ajax: {
            url: "{% url 'orders:search_customers' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term // search term
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: true
        },
        placeholder: window.translations?.[window.currentLanguage]?.['orders.selectCustomerPlaceholder'] || '-- Select Customer --',
        allowClear: true,
        minimumInputLength: 0,
        width: '100%'
    });
    
    // Initialize Select2 for category search
    $('#categorySelect').select2({
        ajax: {
            url: "{% url 'orders:search_categories' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                const branchId = $('#branchSelect').val();
                return {
                    q: params.term || '',
                    branch: branchId || ''
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: false // Don't cache to allow branch filter changes
        },
        placeholder: window.translations?.[window.currentLanguage]?.['orders.branchPlaceholderCenterFirst'] || '-- Select Branch First --',
        allowClear: true,
        minimumInputLength: 0,
        minimumResultsForSearch: 0,
        width: '100%',
        language: {
            searching: function() {
                return window.translations?.[window.currentLanguage]?.['common.searching'] || 'Searching...';
            },
            noResults: function() {
                return window.translations?.[window.currentLanguage]?.['orders.noCategories'] || 'No categories found';
            }
        }
    });
    
    // Initialize Select2 for product search with category filtering
    $('#productSelect').select2({
        ajax: {
            url: "{% url 'orders:search_products' %}",
            dataType: 'json',
            delay: 250,
            data: function (params) {
                const branchId = $('#branchSelect').val();
                const categoryId = $('#categorySelect').val();
                return {
                    q: params.term || '',
                    branch: branchId || '',
                    category: categoryId || ''
                };
            },
            processResults: function (data) {
                return {
                    results: data.results
                };
            },
            cache: false // Don't cache to allow category/branch filter changes
        },
        placeholder: window.translations?.[window.currentLanguage]?.['orders.branchPlaceholderCenterFirst'] || '-- Select Branch First --',
        allowClear: true,
        minimumInputLength: 0,
        minimumResultsForSearch: 0,
        width: '100%',
        language: {
            searching: function() {
                return window.translations?.[window.currentLanguage]?.['common.searching'] || 'Searching...';
            },
            noResults: function() {
                return window.translations?.[window.currentLanguage]?.['orders.noProducts'] || 'No products found';
            }
        }
    });
    
    // When category changes, clear and refresh product dropdown
    $('#categorySelect').on('change', function() {
        // Clear current product selection
        $('#productSelect').val(null).trigger('change');
        // Trigger Select2 to reload with new category filter
        $('#productSelect').select2('close');
    });
    
    // When branch changes, clear category and product selections
    $('#branchSelect').on('change', function() {
        // Clear category and product selections
        $('#categorySelect').val(null).trigger('change');
        $('#productSelect').val(null).trigger('change');
        // Trigger Select2 to reload with new branch filter
        $('#categorySelect').select2('close');
        $('#productSelect').select2('close');
    });
    
    // Manual Order Toggle
    const manualOrderToggle = document.getElementById('manualOrderToggle');
    const botUserSection = document.getElementById('botUserSection');
    const manualCustomerSection = document.getElementById('manualCustomerSection');
    const customerSelect = document.getElementById('customerSelect');
    const manualFirstName = document.getElementById('manualFirstName');
    const manualPhone = document.getElementById('manualPhone');
    
    if (manualOrderToggle) {
        manualOrderToggle.addEventListener('change', function() {
            if (this.checked) {
                // Show manual fields, hide bot user selection
                botUserSection.style.display = 'none';
                manualCustomerSection.style.display = 'block';
                
                // Update field requirements
                customerSelect.removeAttribute('required');
                $('#customerSelect').val(null).trigger('change'); // Clear Select2
                manualFirstName.setAttribute('required', 'required');
                manualPhone.setAttribute('required', 'required');
            } else {
                // Show bot user selection, hide manual fields
                botUserSection.style.display = 'block';
                manualCustomerSection.style.display = 'none';
                
                // Update field requirements
                customerSelect.setAttribute('required', 'required');
                manualFirstName.removeAttribute('required');
                manualPhone.removeAttribute('required');
                
                // Clear manual fields
                manualFirstName.value = '';
                document.getElementById('manualLastName').value = '';
                manualPhone.value = '';
            }
        });
    }
    
    // Center-Branch filtering (for superusers)
    const centerSelect = document.getElementById('centerSelect');
    const branchSelect = document.getElementById('branchSelect');
    
    if (centerSelect && branchSelect) {
        // Get branch data from JSON
        let branchesData = [];
        try {
            const jsonScript = document.getElementById('branchesJson');
            if (jsonScript) {
                const jsonText = jsonScript.textContent.trim();
                console.log('Raw JSON text:', jsonText);
                branchesData = JSON.parse(jsonText);
            }
        } catch(e) {
            console.error('Error parsing branches JSON:', e);
        }
        
        console.log('Branches data loaded:', branchesData.length, branchesData);
        
        centerSelect.addEventListener('change', function() {
            const selectedCenter = this.value;
            console.log('Selected center:', selectedCenter, 'type:', typeof selectedCenter);
            
            // Reset branch selection
            branchSelect.innerHTML = '';
            
            if (selectedCenter) {
                // Add placeholder
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = window.translations?.[window.currentLanguage]?.['orders.branchPlaceholder'] || '-- Select Branch --';
                branchSelect.appendChild(placeholder);
                
                // Filter and add matching branches
                let matchCount = 0;
                const selectedCenterId = parseInt(selectedCenter);
                branchesData.forEach(branch => {
                    console.log('Checking branch:', branch.id, 'center:', branch.center_id, '===', selectedCenterId, '?', branch.center_id === selectedCenterId);
                    if (branch.center_id === selectedCenterId) {
                        const option = document.createElement('option');
                        option.value = branch.id;
                        option.textContent = branch.name;
                        branchSelect.appendChild(option);
                        matchCount++;
                        console.log('Added branch:', branch.name);
                    }
                });
                console.log('Total matches:', matchCount);
                
                // If no branches found, show message
                if (matchCount === 0) {
                    branchSelect.innerHTML = `<option value="">${window.translations?.[window.currentLanguage]?.['orders.noBranches'] || '-- No branches for this center --'}</option>`;
                }
            } else {
                // Add placeholder for no center selected
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = window.translations?.[window.currentLanguage]?.['orders.branchPlaceholderCenterFirst'] || '-- Select Center First --';
                branchSelect.appendChild(placeholder);
            }
        });
    } else {
        console.log('Center/Branch selects not found (non-superuser view)');
    }
    
    // Price calculation
    function calculatePrice() {
        const totalPages = parseInt(document.getElementById('totalPages').value) || 1;
        const copyNumber = parseInt(document.getElementById('copyNumber').value) || 0;

        // Determine customer type (manual orders are treated as non-agency)
        const isManualOrder = document.getElementById('manualOrderToggle')?.checked;
        const customerData = $('#customerSelect').select2('data')[0];
        const isAgency = !isManualOrder && !!(customerData && customerData.is_agency);
        
        // Get selected product data from Select2
        const productData = $('#productSelect').select2('data')[0];
        
        if (productData && productData.price_first !== undefined) {
            const charging = productData.charging || 'dynamic';

            // Pick base prices based on customer type
            const priceFirst = parseFloat(
                isAgency ? (productData.price_first_agency ?? productData.price_first) : productData.price_first
            ) || 0;
            const priceOther = parseFloat(
                isAgency ? (productData.price_other_agency ?? productData.price_other) : productData.price_other
            ) || 0;

            // Base/original price
            let basePrice = 0;
            if (charging === 'dynamic') {
                basePrice = priceFirst + ((Math.max(totalPages, 1) - 1) * priceOther);
            } else {
                basePrice = priceFirst;
            }

            // Copy charge: fixed per copy if available, else legacy percentage of base price
            let copyCharge = 0;
            if (copyNumber > 0) {
                const fixedCopyPrice = parseFloat(
                    isAgency ? productData.agency_copy_price_fixed : productData.user_copy_price_fixed
                );

                if (!Number.isNaN(fixedCopyPrice)) {
                    copyCharge = fixedCopyPrice * copyNumber;
                } else {
                    const pct = parseFloat(
                        isAgency ? productData.agency_copy_price_percentage : productData.user_copy_price_percentage
                    ) || 0;
                    copyCharge = (basePrice * pct * copyNumber) / 100;
                }
            }

            const estimatedTotal = basePrice + copyCharge;

            document.getElementById('estimatedPrice').textContent =
                estimatedTotal.toLocaleString('en-US') + ' UZS';
        } else {
            document.getElementById('estimatedPrice').textContent = '0 UZS';
        }
    }
    
    // Attach event listeners for price calculation
    $('#productSelect').on('change', calculatePrice);
    document.getElementById('totalPages')?.addEventListener('input', calculatePrice);
    document.getElementById('copyNumber')?.addEventListener('input', calculatePrice);
    
    // Initial calculation
    calculatePrice();
    
    // Show/hide receipt upload based on payment type
    const paymentTypeSelect = document.getElementById('paymentType');
    const receiptSection = document.getElementById('receiptSection');
    
    if (paymentTypeSelect && receiptSection) {
        paymentTypeSelect.addEventListener('change', function() {
            if (this.value === 'card') {
                receiptSection.style.display = 'block';
            } else {
                receiptSection.style.display = 'none';
            }
        });
        
        // Initialize on page load
        if (paymentTypeSelect.value === 'card') {
            receiptSection.style.display = 'block';
        }
    }
});  // End DOMContentLoaded
</script>
{% endblock script %}
