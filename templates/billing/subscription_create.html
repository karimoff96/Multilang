{% extends "layout/layout.html" %}
{% load i18n %}

{% block title %}{% trans "Create Subscription" %}{% endblock %}

{% block content %}
<div class="dashboard-main-body">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-24">
        <h6 class="fw-semibold mb-0">{% trans "Create Subscription for" %} {{ center.name }}</h6>
        <ul class="d-flex align-items-center gap-2">
            <li class="fw-medium">
                <a href="{% url 'billing:centers_list' %}" class="d-flex align-items-center gap-1 hover-text-primary">
                    <iconify-icon icon="solar:arrow-left-bold" class="icon text-lg"></iconify-icon>
                    {% trans "Back to Centers" %}
                </a>
            </li>
        </ul>
    </div>

    <div class="card">
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                
                <div class="row gy-3">
                    <div class="col-md-6">
                        <label class="form-label">{% trans "Select Tariff" %} *</label>
                        <select name="tariff" id="tariffSelect" class="form-select" required>
                            <option value="">{% trans "Choose tariff..." %}</option>
                            {% for tariff in tariffs %}
                            <option value="{{ tariff.id }}" data-pricing='{{ tariff.pricing.all|safe }}'>
                                {{ tariff.title }} - 
                                {% if tariff.max_branches %}{{ tariff.max_branches }}{% else %}∞{% endif %} branches, 
                                {% if tariff.max_staff %}{{ tariff.max_staff }}{% else %}∞{% endif %} staff
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{% trans "Select Duration & Price" %} *</label>
                        <select name="pricing" id="pricingSelect" class="form-select" required>
                            <option value="">{% trans "Select tariff first..." %}</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{% trans "Start Date" %} *</label>
                        <input type="date" name="start_date" class="form-control" required value="{% now 'Y-m-d' %}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{% trans "Status" %} *</label>
                        <select name="status" class="form-select">
                            <option value="pending">{% trans "Pending" %}</option>
                            <option value="active">{% trans "Active" %}</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{% trans "Amount Paid" %}</label>
                        <input type="number" step="0.01" name="amount_paid" class="form-control" placeholder="0.00">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{% trans "Payment Method" %}</label>
                        <select name="payment_method" class="form-select">
                            <option value="">{% trans "Not specified" %}</option>
                            <option value="cash">{% trans "Cash" %}</option>
                            <option value="bank_transfer">{% trans "Bank Transfer" %}</option>
                            <option value="click">Click</option>
                            <option value="payme">Payme</option>
                            <option value="uzum">Uzum</option>
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{% trans "Transaction ID" %}</label>
                        <input type="text" name="transaction_id" class="form-control" placeholder="{% trans 'Optional' %}">
                    </div>

                    <div class="col-md-6">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" name="auto_renew" id="autoRenew" checked>
                            <label class="form-check-label" for="autoRenew">
                                {% trans "Auto-renew subscription" %}
                            </label>
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">{% trans "Notes" %}</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="{% trans 'Optional notes...' %}"></textarea>
                    </div>

                    <div class="col-12">
                        <button type="submit" class="btn btn-primary-600">
                            <iconify-icon icon="solar:add-circle-bold"></iconify-icon> {% trans "Create Subscription" %}
                        </button>
                        <a href="{% url 'billing:centers_list' %}" class="btn btn-secondary-600">{% trans "Cancel" %}</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.getElementById('tariffSelect').addEventListener('change', function() {
    const pricingSelect = document.getElementById('pricingSelect');
    pricingSelect.innerHTML = '<option value="">{% trans "Choose duration..." %}</option>';
    
    const selectedTariff = this.options[this.selectedIndex];
    if (!selectedTariff.value) return;
    
    // Get pricing from tariff data
    const tariffId = selectedTariff.value;
    fetch(`/admin/billing/tariffpricing/?tariff__id__exact=${tariffId}`)
        .then(() => {
            // Simplified: add pricing options dynamically
            {% for tariff in tariffs %}
            if ({{ tariff.id }} == tariffId) {
                {% for pricing in tariff.pricing.all %}
                pricingSelect.innerHTML += `<option value="{{ pricing.id }}">{{ pricing.duration_months }} month(s) - {{ pricing.price|floatformat:0 }} {{ pricing.currency }}{% if pricing.discount_percentage > 0 %} ({{ pricing.discount_percentage }}% off){% endif %}</option>`;
                {% endfor %}
            }
            {% endfor %}
        });
});
</script>
{% endblock %}
