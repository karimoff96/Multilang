{% extends "layout/layout.html" %}
{% load i18n %}

{% block title %}{% trans "Edit Tariff" %} - {{ tariff.title }}{% endblock %}

{% block content %}
<style>
    /* Fix checkbox alignment with multi-line labels */
    .form-check {
        display: flex;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }
    
    .form-check-input {
        margin-top: 0.25rem;
        flex-shrink: 0;
    }
    
    .form-check-label {
        margin-left: 0.5rem;
        line-height: 1.5;
    }
    
    .form-check-label strong {
        display: block;
        margin-bottom: 0.125rem;
    }
    
    .form-check-label small {
        display: block;
        line-height: 1.4;
    }
</style>

<div class="dashboard-main-body">
    <div class="d-flex justify-content-end gap-3 mb-24">
        <a href="{% url 'billing:tariff_list' %}" class="btn btn-outline-primary-600">
            <i class="ri-arrow-left-line"></i> {% trans "Back to List" %}
        </a>
    </div>

    <div class="card">
        <div class="card-body p-24">
            <form method="post">
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div class="row gy-3 mb-32">
                    <div class="col-12">
                        <h6 class="text-md text-primary-light mb-16">{% trans "Basic Information" %}</h6>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label">{% trans "Title" %} *</label>
                        <input type="text" name="title" class="form-control" required 
                               value="{{ tariff.title }}"
                               placeholder="{% trans 'e.g., Starter, Professional, Enterprise' %}">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">{% trans "Slug" %} *</label>
                        <input type="text" name="slug" class="form-control" required 
                               value="{{ tariff.slug }}"
                               placeholder="{% trans 'e.g., starter, professional, enterprise' %}"
                               pattern="[a-z0-9-]+" title="{% trans 'Only lowercase letters, numbers, and hyphens' %}">
                        <small class="text-secondary-light">{% trans "URL-friendly identifier (lowercase, no spaces)" %}</small>
                    </div>

                    <div class="col-12">
                        <label class="form-label">{% trans "Description" %}</label>
                        <textarea name="description" class="form-control" rows="3" 
                                  placeholder="{% trans 'Describe this tariff plan...' %}">{{ tariff.description }}</textarea>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">{% trans "Display Order" %}</label>
                        <input type="number" name="display_order" class="form-control" value="{{ tariff.display_order }}">
                        <small class="text-secondary-light">{% trans "Lower numbers appear first" %}</small>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label d-block mb-8">&nbsp;</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_active" id="isActive" 
                                   {% if tariff.is_active %}checked{% endif %}>
                            <label class="form-check-label" for="isActive">
                                {% trans "Active" %}
                            </label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label d-block mb-8">&nbsp;</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_featured" id="isFeatured"
                                   {% if tariff.is_featured %}checked{% endif %}>
                            <label class="form-check-label" for="isFeatured">
                                {% trans "Featured" %}
                            </label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label d-block mb-8">&nbsp;</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="is_trial" id="isTrial" 
                                   {% if tariff.is_trial %}checked{% endif %}
                                   onchange="toggleTrialSettings()">
                            <label class="form-check-label" for="isTrial">
                                {% trans "Is Trial" %}
                            </label>
                        </div>
                    </div>

                    <div class="col-md-6" id="trialDaysContainer" style="display:{% if tariff.is_trial %}block{% else %}none{% endif %};">
                        <label class="form-label">{% trans "Trial Days" %}</label>
                        <input type="number" name="trial_days" id="trialDays" class="form-control" 
                               value="{{ tariff.trial_days|default:'10' }}" min="1">
                        <small class="text-secondary-light">{% trans "Number of days for free trial period" %}</small>
                    </div>
                </div>

                <!-- Limits -->
                <div class="row gy-3 mb-32">
                    <div class="col-12">
                        <h6 class="text-md text-primary-light mb-8">{% trans "Resource Limits" %}</h6>
                        <p class="text-sm text-secondary-light mb-16">{% trans "Leave empty for unlimited access" %}</p>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">{% trans "Max Branches" %}</label>
                        <input type="number" name="max_branches" class="form-control" min="0" 
                               value="{{ tariff.max_branches|default:'' }}"
                               placeholder="{% trans 'Empty = Unlimited' %}">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">{% trans "Max Staff" %}</label>
                        <input type="number" name="max_staff" class="form-control" min="0" 
                               value="{{ tariff.max_staff|default:'' }}"
                               placeholder="{% trans 'Empty = Unlimited' %}">
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">{% trans "Max Monthly Orders" %}</label>
                        <input type="number" name="max_monthly_orders" class="form-control" min="0" 
                               value="{{ tariff.max_monthly_orders|default:'' }}"
                               placeholder="{% trans 'Empty = Unlimited' %}">
                    </div>
                </div>

                <!-- Features -->
                <div class="row gy-3 mb-32">
                    <div class="col-12">
                        <h6 class="text-md text-primary-light mb-16">
                            {% trans "Included Features" %}
                            <span class="badge bg-primary-600 text-white ms-2" id="featureCount">0/37</span>
                        </h6>
                        <p class="text-sm text-secondary-light mb-16">{% trans "Select features available in this tariff plan" %}</p>
                    </div>

                    <!-- Orders Features -->
                    <div class="col-12 mb-20">
                        <div class="card bg-neutral-50 border">
                            <div class="card-header bg-transparent border-bottom">
                                <h6 class="mb-0">üìä {% trans "Order Management Features" %} <span class="text-secondary-light">(5)</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row gy-2">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_orders_basic" id="feature_orders_basic"
                                                   {% if tariff.feature_orders_basic %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_orders_basic">
                                                <strong>{% trans "Basic Order Management" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Create, view, and track customer orders" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_orders_advanced" id="feature_orders_advanced"
                                                   {% if tariff.feature_orders_advanced %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_orders_advanced">
                                                <strong>{% trans "Advanced Order Management" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Bulk operations, advanced filters, export" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_order_assignment" id="feature_order_assignment"
                                                   {% if tariff.feature_order_assignment %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_order_assignment">
                                                <strong>{% trans "Order Assignment" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Assign orders to specific staff members" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_bulk_payments" id="feature_bulk_payments"
                                                   {% if tariff.feature_bulk_payments %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_bulk_payments">
                                                <strong>{% trans "Bulk Payment Processing" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Process payments across multiple orders" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_order_templates" id="feature_order_templates"
                                                   {% if tariff.feature_order_templates %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_order_templates">
                                                <strong>{% trans "Order Templates" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Save and reuse order configurations" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Features -->
                    <div class="col-12 mb-20">
                        <div class="card bg-neutral-50 border">
                            <div class="card-header bg-transparent border-bottom">
                                <h6 class="mb-0">üìà {% trans "Analytics & Reports Features" %} <span class="text-secondary-light">(6)</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row gy-2">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_analytics_basic" id="feature_analytics_basic"
                                                   {% if tariff.feature_analytics_basic %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_analytics_basic">
                                                <strong>{% trans "Basic Analytics" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "View order counts and basic statistics" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_analytics_advanced" id="feature_analytics_advanced"
                                                   {% if tariff.feature_analytics_advanced %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_analytics_advanced">
                                                <strong>{% trans "Advanced Analytics" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Detailed reports, financial analytics, trends" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_financial_reports" id="feature_financial_reports"
                                                   {% if tariff.feature_financial_reports %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_financial_reports">
                                                <strong>{% trans "Financial Reports" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Revenue, profit, expense analysis" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_staff_performance" id="feature_staff_performance"
                                                   {% if tariff.feature_staff_performance %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_staff_performance">
                                                <strong>{% trans "Staff Performance Reports" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Track individual staff productivity" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_custom_reports" id="feature_custom_reports"
                                                   {% if tariff.feature_custom_reports %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_custom_reports">
                                                <strong>{% trans "Custom Report Builder" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Create custom reports with filters" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_export_reports" id="feature_export_reports"
                                                   {% if tariff.feature_export_reports %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_export_reports">
                                                <strong>{% trans "Export Reports" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Export to Excel, PDF, CSV formats" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Integration Features -->
                    <div class="col-12 mb-20">
                        <div class="card bg-neutral-50 border">
                            <div class="card-header bg-transparent border-bottom">
                                <h6 class="mb-0">üîó {% trans "Integration Features" %} <span class="text-secondary-light">(4)</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row gy-2">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_telegram_bot" id="feature_telegram_bot"
                                                   {% if tariff.feature_telegram_bot %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_telegram_bot">
                                                <strong>{% trans "Telegram Bot Integration" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Customer-facing bot for order placement" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_webhooks" id="feature_webhooks"
                                                   {% if tariff.feature_webhooks %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_webhooks">
                                                <strong>{% trans "Webhook Management" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Configure and manage Telegram webhooks" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_api_access" id="feature_api_access"
                                                   {% if tariff.feature_api_access %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_api_access">
                                                <strong>{% trans "REST API Access" %}</strong>
                                                <span class="badge bg-warning-600 text-white text-xs ms-1">{% trans "On Request" %}</span>
                                                <br><small class="text-secondary-light">{% trans "REST API for custom integrations" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_integrations" id="feature_integrations"
                                                   {% if tariff.feature_integrations %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_integrations">
                                                <strong>{% trans "Third-Party Integrations" %}</strong>
                                                <span class="badge bg-warning-600 text-white text-xs ms-1">{% trans "On Request" %}</span>
                                                <br><small class="text-secondary-light">{% trans "Custom integrations with external services" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Marketing & Organization Features -->
                    <div class="col-md-6 mb-20">
                        <div class="card bg-neutral-50 border h-100">
                            <div class="card-header bg-transparent border-bottom">
                                <h6 class="mb-0">üì¢ {% trans "Marketing Features" %} <span class="text-secondary-light">(2)</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row gy-2">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_marketing_basic" id="feature_marketing_basic"
                                                   {% if tariff.feature_marketing_basic %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_marketing_basic">
                                                <strong>{% trans "Marketing Campaign Tools" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Create and manage marketing posts" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_broadcast_messages" id="feature_broadcast_messages"
                                                   {% if tariff.feature_broadcast_messages %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_broadcast_messages">
                                                <strong>{% trans "Mass Broadcast Messaging" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Send targeted broadcasts to customers" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Organization Features -->
                    <div class="col-md-6 mb-20">
                        <div class="card bg-neutral-50 border h-100">
                            <div class="card-header bg-transparent border-bottom">
                                <h6 class="mb-0">üè¢ {% trans "Organization & Staff Features" %} <span class="text-secondary-light">(4)</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row gy-2">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_multi_branch" id="feature_multi_branch"
                                                   {% if tariff.feature_multi_branch %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_multi_branch">
                                                <strong>{% trans "Multi-Branch Management" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Manage multiple branches/locations" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_custom_roles" id="feature_custom_roles"
                                                   {% if tariff.feature_custom_roles %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_custom_roles">
                                                <strong>{% trans "Custom Roles & Permissions" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Create custom staff roles with specific permissions" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_staff_scheduling" id="feature_staff_scheduling"
                                                   {% if tariff.feature_staff_scheduling %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_staff_scheduling">
                                                <strong>{% trans "Staff Scheduling" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Schedule shifts and manage availability" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_branch_settings" id="feature_branch_settings"
                                                   {% if tariff.feature_branch_settings %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_branch_settings">
                                                <strong>{% trans "Branch-Specific Settings" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Configure settings per branch" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Storage & Financial Features -->
                    <div class="col-md-6 mb-20">
                        <div class="card bg-neutral-50 border h-100">
                            <div class="card-header bg-transparent border-bottom">
                                <h6 class="mb-0">üì¶ {% trans "Storage & Archive Features" %} <span class="text-secondary-light">(3)</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row gy-2">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_archive_access" id="feature_archive_access"
                                                   {% if tariff.feature_archive_access %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_archive_access">
                                                <strong>{% trans "Archive Access" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Access archived orders and data" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_cloud_backup" id="feature_cloud_backup"
                                                   {% if tariff.feature_cloud_backup %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_cloud_backup">
                                                <strong>{% trans "Cloud Backup" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Automatic cloud backup of data" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_extended_storage" id="feature_extended_storage"
                                                   {% if tariff.feature_extended_storage %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_extended_storage">
                                                <strong>{% trans "Extended Storage" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Increased file storage capacity" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Features -->
                    <div class="col-md-6 mb-20">
                        <div class="card bg-neutral-50 border h-100">
                            <div class="card-header bg-transparent border-bottom">
                                <h6 class="mb-0">üí∞ {% trans "Financial Management Features" %} <span class="text-secondary-light">(4)</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row gy-2">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_payment_management" id="feature_payment_management"
                                                   {% if tariff.feature_payment_management %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_payment_management">
                                                <strong>{% trans "Payment Management" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Track payments and payment status" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_multi_currency" id="feature_multi_currency"
                                                   {% if tariff.feature_multi_currency %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_multi_currency">
                                                <strong>{% trans "Multi-Currency Support" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Accept payments in multiple currencies" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_invoicing" id="feature_invoicing"
                                                   {% if tariff.feature_invoicing %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_invoicing">
                                                <strong>{% trans "Invoice Generation" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Generate and send invoices" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_expense_tracking" id="feature_expense_tracking"
                                                   {% if tariff.feature_expense_tracking %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_expense_tracking">
                                                <strong>{% trans "Expense Tracking" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Track business expenses" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Support & Advanced Features -->
                    <div class="col-md-6 mb-20">
                        <div class="card bg-neutral-50 border h-100">
                            <div class="card-header bg-transparent border-bottom">
                                <h6 class="mb-0">üéØ {% trans "Support Features" %} <span class="text-secondary-light">(2)</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row gy-2">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_support_tickets" id="feature_support_tickets"
                                                   {% if tariff.feature_support_tickets %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_support_tickets">
                                                <strong>{% trans "Support Ticket System" %}</strong>
                                                <span class="badge bg-info-600 text-white text-xs ms-1">{% trans "Docs" %}</span>
                                                <br><small class="text-secondary-light">{% trans "Submit and track support tickets" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_knowledge_base" id="feature_knowledge_base"
                                                   {% if tariff.feature_knowledge_base %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_knowledge_base">
                                                <strong>{% trans "Knowledge Base Access" %}</strong>
                                                <span class="badge bg-info-600 text-white text-xs ms-1">{% trans "Docs" %}</span>
                                                <br><small class="text-secondary-light">{% trans "Access help documentation" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Features -->
                    <div class="col-md-6 mb-20">
                        <div class="card bg-neutral-50 border h-100">
                            <div class="card-header bg-transparent border-bottom">
                                <h6 class="mb-0">‚ö° {% trans "Advanced Features" %} <span class="text-secondary-light">(3)</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row gy-2">
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_advanced_security" id="feature_advanced_security"
                                                   {% if tariff.feature_advanced_security %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_advanced_security">
                                                <strong>{% trans "Advanced Security" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Enhanced security features" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_audit_logs" id="feature_audit_logs"
                                                   {% if tariff.feature_audit_logs %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_audit_logs">
                                                <strong>{% trans "Audit Logs" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Track all system activities" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_data_retention" id="feature_data_retention"
                                                   {% if tariff.feature_data_retention %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_data_retention">
                                                <strong>{% trans "Data Retention Policies" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Configure data retention rules" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Services Features -->
                    <div class="col-12 mb-20">
                        <div class="card bg-neutral-50 border">
                            <div class="card-header bg-transparent border-bottom">
                                <h6 class="mb-0">üõ†Ô∏è {% trans "Services Management Features" %} <span class="text-secondary-light">(4)</span></h6>
                            </div>
                            <div class="card-body">
                                <div class="row gy-2">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_products_basic" id="feature_products_basic"
                                                   {% if tariff.feature_products_basic %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_products_basic">
                                                <strong>{% trans "Basic Product Management" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Manage products and services catalog" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_products_advanced" id="feature_products_advanced"
                                                   {% if tariff.feature_products_advanced %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_products_advanced">
                                                <strong>{% trans "Advanced Product Management" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Variants, categories, inventory tracking" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_language_pricing" id="feature_language_pricing"
                                                   {% if tariff.feature_language_pricing %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_language_pricing">
                                                <strong>{% trans "Language-Specific Pricing" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Set prices per language pair" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input feature-checkbox" type="checkbox" 
                                                   name="feature_dynamic_pricing" id="feature_dynamic_pricing"
                                                   {% if tariff.feature_dynamic_pricing %}checked{% endif %}>
                                            <label class="form-check-label" for="feature_dynamic_pricing">
                                                <strong>{% trans "Dynamic Pricing Rules" %}</strong>
                                                <br><small class="text-secondary-light">{% trans "Price calculation based on rules" %}</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pricing Options -->
                <div class="row gy-3 mb-32">
                    <div class="col-12">
                        <h6 class="text-md text-primary-light mb-16">{% trans "Pricing Options" %}</h6>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label class="form-label">{% trans "Base Monthly Price" %} *</label>
                        <input type="number" id="basePrice" class="form-control" step="0.01" min="0" 
                               placeholder="{% trans 'e.g., 299000' %}" onchange="updateAllPrices()">
                        <small class="text-secondary-light">{% trans "Full price per month without any discount" %}</small>
                    </div>
                    
                    <div class="col-12">
                        <div id="pricingContainer">
                            {% for pricing in tariff.pricing.all %}
                            <div class="row gy-3 mb-3 pricing-row border-bottom pb-3">
                                <div class="col-md-2">
                                    <label class="form-label">{% trans "Duration (Months)" %}</label>
                                    <input type="number" name="pricing_duration[]" class="form-control duration-input" 
                                           value="{{ pricing.duration_months }}" min="1" required onchange="calculatePrice(this)">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">{% trans "Discount %" %}</label>
                                    <input type="number" name="pricing_discount[]" class="form-control discount-input" 
                                           value="{{ pricing.discount_percent|default:0 }}" min="0" max="100" step="0.1" 
                                           onchange="calculatePrice(this)" placeholder="0">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">{% trans "Monthly Price" %}</label>
                                    <input type="number" name="pricing_monthly[]" class="form-control monthly-price" 
                                           value="{{ pricing.monthly_price|floatformat:2 }}" step="0.01" min="0" required readonly>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">{% trans "Total Price" %}</label>
                                    <input type="number" name="pricing_total[]" class="form-control total-price" 
                                           value="{{ pricing.price|floatformat:2 }}" step="0.01" min="0" required readonly>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">{% trans "Currency" %}</label>
                                    <select name="pricing_currency[]" class="form-control" required>
                                        <option value="UZS" {% if pricing.currency == 'UZS' %}selected{% endif %}>UZS</option>
                                        <option value="USD" {% if pricing.currency == 'USD' %}selected{% endif %}>USD</option>
                                    </select>
                                </div>
                                <div class="col-md-1 d-flex align-items-end">
                                    <button type="button" class="btn btn-outline-danger-600 w-100" onclick="removePricing(this)">
                                        <i class="ri-delete-bin-line"></i>
                                    </button>
                                </div>
                                <input type="hidden" name="pricing_id[]" value="{{ pricing.id }}">
                            </div>
                            {% endfor %}
                        </div>
                        
                        <button type="button" class="btn btn-outline-primary-600 mt-2" onclick="addPricing()">
                            <i class="ri-add-line"></i> {% trans "Add Pricing Option" %}
                        </button>
                        <small class="text-secondary-light d-block mt-2">
                            <i class="ri-information-line"></i> {% trans "Set discount % for longer durations. Prices calculate automatically." %}
                        </small>
                    </div>
                </div>

                <!-- Warning if tariff has subscriptions -->
                {% if tariff.subscriptions.count > 0 %}
                <div class="alert alert-warning mb-24">
                    <i class="ri-alert-line"></i>
                    {% blocktrans count counter=tariff.subscriptions.count %}
                    This tariff has {{ counter }} subscription. Changes may affect active subscriptions.
                    {% plural %}
                    This tariff has {{ counter }} subscriptions. Changes may affect active subscriptions.
                    {% endblocktrans %}
                </div>
                {% endif %}

                <!-- Actions -->
                <div class="d-flex gap-2 justify-content-end">
                    <a href="{% url 'billing:tariff_list' %}" class="btn btn-outline-secondary-600">
                        {% trans "Cancel" %}
                    </a>
                    <button type="submit" class="btn btn-primary-600">
                        <i class="ri-save-line"></i> {% trans "Save Changes" %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Update feature count
function updateFeatureCount() {
    const checkboxes = document.querySelectorAll('.feature-checkbox');
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    const totalCount = checkboxes.length;
    document.getElementById('featureCount').textContent = `${checkedCount}/${totalCount}`;
}

// Attach listeners to all feature checkboxes
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.feature-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateFeatureCount);
    });
    updateFeatureCount(); // Initial count
});

function toggleTrialSettings() {
    const isTrial = document.getElementById('isTrial').checked;
    const trialContainer = document.getElementById('trialDaysContainer');
    const trialDaysInput = document.getElementById('trialDays');
    
    if (isTrial) {
        trialContainer.style.display = 'block';
        trialDaysInput.required = true;
    } else {
        trialContainer.style.display = 'none';
        trialDaysInput.required = false;
    }
}

function calculatePrice(element) {
    const row = element.closest('.pricing-row');
    const basePrice = parseFloat(document.getElementById('basePrice').value) || 0;
    const duration = parseInt(row.querySelector('.duration-input').value) || 1;
    const discount = parseFloat(row.querySelector('.discount-input').value) || 0;
    
    if (basePrice > 0) {
        // Calculate monthly price with discount
        const monthlyPrice = basePrice * (1 - discount / 100);
        const totalPrice = monthlyPrice * duration;
        
        // Round to nearest 100 for cleaner prices
        const roundedMonthly = Math.round(monthlyPrice / 100) * 100;
        const roundedTotal = Math.round(totalPrice / 100) * 100;
        
        row.querySelector('.monthly-price').value = roundedMonthly.toFixed(2);
        row.querySelector('.total-price').value = roundedTotal.toFixed(2);
    }
}

function updateAllPrices() {
    const rows = document.querySelectorAll('.pricing-row');
    rows.forEach(row => {
        calculatePrice(row.querySelector('.duration-input'));
    });
}

function addPricing() {
    const container = document.getElementById('pricingContainer');
    const newRow = `
        <div class="row gy-3 mb-3 pricing-row border-bottom pb-3">
            <div class="col-md-2">
                <label class="form-label">{% trans "Duration (Months)" %}</label>
                <input type="number" name="pricing_duration[]" class="form-control duration-input" min="1" required onchange="calculatePrice(this)" value="1">
            </div>
            <div class="col-md-2">
                <label class="form-label">{% trans "Discount %" %}</label>
                <input type="number" name="pricing_discount[]" class="form-control discount-input" min="0" max="100" step="0.1" onchange="calculatePrice(this)" placeholder="0" value="0">
            </div>
            <div class="col-md-2">
                <label class="form-label">{% trans "Monthly Price" %}</label>
                <input type="number" name="pricing_monthly[]" class="form-control monthly-price" step="0.01" min="0" required readonly>
            </div>
            <div class="col-md-3">
                <label class="form-label">{% trans "Total Price" %}</label>
                <input type="number" name="pricing_total[]" class="form-control total-price" step="0.01" min="0" required readonly>
            </div>
            <div class="col-md-2">
                <label class="form-label">{% trans "Currency" %}</label>
                <select name="pricing_currency[]" class="form-control" required>
                    <option value="UZS" selected>UZS</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="button" class="btn btn-outline-danger-600 w-100" onclick="removePricing(this)">
                    <i class="ri-delete-bin-line"></i>
                </button>
            </div>
            <input type="hidden" name="pricing_id[]" value="">
        </div>
    `;
    container.insertAdjacentHTML('beforeend', newRow);
    updateAllPrices();
}

function removePricing(button) {
    const row = button.closest('.pricing-row');
    if (document.querySelectorAll('.pricing-row').length > 1 || confirm('{% trans "Remove this pricing option?" %}')) {
        row.remove();
    }
}

// Initialize base price from first pricing option on load
document.addEventListener('DOMContentLoaded', function() {
    const firstMonthly = document.querySelector('.monthly-price');
    const firstDiscount = document.querySelector('.discount-input');
    
    if (firstMonthly && firstDiscount) {
        const discount = parseFloat(firstDiscount.value) || 0;
        const monthly = parseFloat(firstMonthly.value) || 0;
        
        if (monthly > 0 && discount >= 0) {
            // Reverse calculate base price from first option
            const basePrice = monthly / (1 - discount / 100);
            document.getElementById('basePrice').value = Math.round(basePrice / 100) * 100;
        }
    }
});
</script>
{% endblock %}
