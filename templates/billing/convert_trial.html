{% extends 'layout/base.html' %}
{% load i18n %}

{% block title %}{% trans "Convert Trial to Paid" %} - {{ subscription.organization.name }}{% endblock %}

{% block content %}
<div class="row gy-4">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="ri-vip-crown-line"></i> {% trans "Convert Trial to Paid Subscription" %}
                </h5>
            </div>
            <div class="card-body">
                <!-- Trial Info -->
                <div class="alert alert-info mb-4">
                    <h6><i class="ri-information-line"></i> {% trans "Current Trial Subscription" %}</h6>
                    <ul class="mb-0">
                        <li><strong>{% trans "Organization" %}:</strong> {{ subscription.organization.name }}</li>
                        <li><strong>{% trans "Trial Started" %}:</strong> {{ subscription.start_date|date:"F d, Y" }}</li>
                        <li><strong>{% trans "Trial Ends" %}:</strong> {{ subscription.trial_end_date|date:"F d, Y" }}</li>
                        <li><strong>{% trans "Days Remaining" %}:</strong> 
                            <span class="badge bg-{% if subscription.trial_days_remaining <= 3 %}danger{% else %}info{% endif %}-600 text-white">
                                {{ subscription.trial_days_remaining }} {% trans "days" %}
                            </span>
                        </li>
                    </ul>
                </div>

                <!-- Conversion Form -->
                <form method="post">
                    {% csrf_token %}
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">{% trans "Select New Tariff" %} *</label>
                            <select name="tariff" id="tariffSelect" class="form-select" required>
                                <option value="">{% trans "Choose a tariff plan..." %}</option>
                                {% for tariff in tariffs %}
                                <option value="{{ tariff.id }}" 
                                    data-branches="{{ tariff.max_branches|default:'∞' }}"
                                    data-staff="{{ tariff.max_staff|default:'∞' }}"
                                    data-orders="{{ tariff.max_monthly_orders|default:'∞' }}">
                                    {{ tariff.title }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-12" id="tariffDetails" style="display:none;">
                            <div class="alert alert-secondary">
                                <h6>{% trans "Tariff Limits" %}</h6>
                                <ul class="mb-0">
                                    <li><strong>{% trans "Branches" %}:</strong> <span id="limitBranches"></span></li>
                                    <li><strong>{% trans "Staff" %}:</strong> <span id="limitStaff"></span></li>
                                    <li><strong>{% trans "Monthly Orders" %}:</strong> <span id="limitOrders"></span></li>
                                </ul>
                            </div>
                        </div>

                        <div class="col-12">
                            <label class="form-label">{% trans "Select Duration & Price" %} *</label>
                            <select name="pricing" id="pricingSelect" class="form-select" required>
                                <option value="">{% trans "Select tariff first..." %}</option>
                            </select>
                        </div>

                        <div class="col-12">
                            <div class="alert alert-warning">
                                <i class="ri-alert-line"></i> 
                                {% trans "After conversion, the trial subscription will be replaced with a paid subscription starting today. Please ensure payment is collected before converting." %}
                            </div>
                        </div>

                        <div class="col-12">
                            <button type="submit" class="btn btn-primary-600">
                                <i class="ri-arrow-right-circle-line"></i> {% trans "Convert to Paid Subscription" %}
                            </button>
                            <a href="{% url 'billing:subscription_detail' subscription.pk %}" class="btn btn-secondary-600">
                                {% trans "Cancel" %}
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Tariff data
const tariffData = {
    {% for tariff in tariffs %}
    {{ tariff.id }}: {
        pricing: [
            {% for pricing in tariff.pricing.all %}
            {
                id: {{ pricing.id }},
                duration: {{ pricing.duration_months }},
                price: {{ pricing.final_price }},
                currency: '{{ pricing.currency }}',
                discount: {{ pricing.discount_percentage }}
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

document.getElementById('tariffSelect').addEventListener('change', function() {
    const tariffId = parseInt(this.value);
    const pricingSelect = document.getElementById('pricingSelect');
    const tariffDetails = document.getElementById('tariffDetails');
    const selectedOption = this.options[this.selectedIndex];
    
    pricingSelect.innerHTML = '<option value="">{% trans "Choose duration..." %}</option>';
    
    if (!tariffId || !tariffData[tariffId]) {
        tariffDetails.style.display = 'none';
        return;
    }
    
    // Show tariff details
    tariffDetails.style.display = 'block';
    document.getElementById('limitBranches').textContent = selectedOption.dataset.branches;
    document.getElementById('limitStaff').textContent = selectedOption.dataset.staff;
    document.getElementById('limitOrders').textContent = selectedOption.dataset.orders;
    
    // Add pricing options
    const tariff = tariffData[tariffId];
    tariff.pricing.forEach(pricing => {
        const discountText = pricing.discount > 0 ? ` (${pricing.discount}% off)` : '';
        pricingSelect.innerHTML += `<option value="${pricing.id}">${pricing.duration} month(s) - ${pricing.price.toFixed(0)} ${pricing.currency}${discountText}</option>`;
    });
});
</script>
{% endblock %}
